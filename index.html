<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <title>Guitar Chord Practice Timer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Tech grid background */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }

        .container {
            background: #111111;
            border: 1px solid #2a2a2a;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 40px;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 300;
            position: relative;
            padding-bottom: 20px;
        }

        h1::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 1px;
            background: linear-gradient(90deg, transparent, #ffffff, transparent);
        }

        /* Mode selector */
        .mode-selector {
            display: flex;
            gap: 0;
            margin-bottom: 40px;
            border: 1px solid #333;
            background: #0a0a0a;
        }

        .mode-btn {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            color: #666;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .mode-btn:not(:last-child) {
            border-right: 1px solid #333;
        }

        .mode-btn:hover {
            background: #1a1a1a;
            color: #999;
        }

        .mode-btn.active {
            background: #ffffff;
            color: #000000;
            font-weight: 600;
        }

        /* Single Chord Mode */
        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        label {
            font-weight: 300;
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input[type="number"] {
            width: 80px;
            padding: 10px;
            border: 1px solid #333;
            background: #0a0a0a;
            color: #ffffff;
            font-size: 14px;
            font-family: inherit;
            text-align: center;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #666;
        }

        button {
            padding: 12px 24px;
            font-size: 12px;
            font-weight: 400;
            border: 1px solid #333;
            background: transparent;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: #ffffff;
            color: #000000;
            border-color: #ffffff;
        }

        .btn-primary {
            border-color: #ffffff;
        }

        .btn-secondary.active {
            background: #ffffff;
            color: #000000;
        }

        .chord-display {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
            border-top: 1px solid #2a2a2a;
            border-bottom: 1px solid #2a2a2a;
        }

        .current-chord {
            font-size: 80px;
            font-weight: 100;
            color: #ffffff;
            margin-bottom: 10px;
            letter-spacing: 8px;
        }

        .chord-info {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }

        /* Chord Changes Mode Display */
        .chord-changes-display {
            display: flex;
            justify-content: center;
            gap: 60px;
            align-items: center;
            margin-bottom: 30px;
        }

        .chord-pair {
            text-align: center;
        }

        .chord-pair .chord {
            font-size: 60px;
            font-weight: 100;
            color: #ffffff;
            letter-spacing: 4px;
            transition: all 0.3s ease;
        }

        .chord-pair .type {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .arrow {
            font-size: 30px;
            color: #666;
        }

        /* Progression Mode Display */
        .progression-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .progression-sequence {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .progression-chord {
            text-align: center;
        }

        .progression-chord .chord {
            font-size: 50px;
            font-weight: 100;
            color: #ffffff;
            letter-spacing: 3px;
            transition: all 0.3s ease;
        }

        .progression-chord .numeral {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .progression-arrow {
            font-size: 24px;
            color: #444;
        }

        .progression-info {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .progression-description {
            font-size: 11px;
            color: #666;
            font-style: italic;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }

        .progression-key {
            font-size: 14px;
            color: #999;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        /* Progress tracking */
        .progress-tracker {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border: 1px solid #333;
            background: #0a0a0a;
            transition: all 0.3s ease;
        }

        .progress-dot.completed {
            background: #666;
        }

        .progress-dot.current {
            background: #ffffff;
        }

        /* Timer and Progress */
        .timer {
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-display {
            font-size: 48px;
            font-weight: 100;
            color: #ffffff;
            letter-spacing: 4px;
        }

        .progress-bar-container {
            height: 3px;
            background: #1a1a1a;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #ffffff;
            width: 100%;
            transition: width 0.1s linear;
        }

        /* Chord List */
        .chords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .chord-tag {
            padding: 8px 16px;
            border: 1px solid #333;
            color: #666;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .chord-tag.current {
            border-color: #ffffff;
            color: #ffffff;
            background: #1a1a1a;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.5s ease;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 18px;
                letter-spacing: 2px;
            }

            .current-chord {
                font-size: 60px;
            }

            .chord-pair .chord {
                font-size: 40px;
            }

            .progression-chord .chord {
                font-size: 35px;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
            }

            .mode-btn {
                padding: 12px 15px;
                font-size: 10px;
            }

            .chord-changes-display {
                gap: 30px;
            }

            .progression-sequence {
                gap: 15px;
            }

            .progression-arrow {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chord Practice</h1>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('single')">Single Chords</button>
            <button class="mode-btn" onclick="switchMode('changes')">Chord Changes</button>
            <button class="mode-btn" onclick="switchMode('progressions')">Progressions</button>
        </div>

        <!-- SINGLE CHORD MODE -->
        <div id="singleMode" class="mode-content active">
            <div class="controls">
                <div class="control-group">
                    <label for="timerInput">Time per chord (s)</label>
                    <input type="number" id="timerInput" value="30" min="5" max="300">
                </div>
                <button id="shuffleBtn" class="btn-secondary" onclick="toggleShuffle()">Shuffle: OFF</button>
            </div>

            <div class="chord-display">
                <div class="current-chord" id="currentChord">C</div>
                <div class="chord-info" id="chordInfo">MAJOR</div>
                
                <div class="timer">
                    <div class="timer-display" id="timerDisplay">30</div>
                </div>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="controls">
                <button id="startBtn" class="btn-primary" onclick="startPractice()">Start</button>
                <button id="pauseBtn" class="btn-primary" onclick="pausePractice()" style="display: none;">Pause</button>
                <button onclick="resetPractice()">Reset</button>
            </div>

            <div class="chords-list" id="chordsList"></div>
        </div>

        <!-- CHORD CHANGES MODE -->
        <div id="changesMode" class="mode-content">
            <div class="controls">
                <div class="control-group">
                    <label for="changeTimerInput">Time per change (s)</label>
                    <input type="number" id="changeTimerInput" value="30" min="5" max="300">
                </div>
            </div>

            <div class="chord-display">
                <div class="chord-changes-display">
                    <div class="chord-pair" id="chord1">
                        <div class="chord">C</div>
                        <div class="type">MAJOR</div>
                    </div>
                    <div class="arrow">→</div>
                    <div class="chord-pair" id="chord2">
                        <div class="chord">G</div>
                        <div class="type">MAJOR</div>
                    </div>
                </div>

                <div class="timer">
                    <div class="timer-display" id="changeTimerDisplay">30</div>
                </div>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="changeProgressBar"></div>
            </div>

            <div class="controls">
                <button id="startChangesBtn" class="btn-primary" onclick="startChanges()">Start</button>
                <button id="pauseChangesBtn" class="btn-primary" onclick="pauseChanges()" style="display: none;">Pause</button>
                <button onclick="resetChanges()">Reset</button>
            </div>
        </div>

        <!-- PROGRESSIONS MODE -->
        <div id="progressionsMode" class="mode-content">
            <div class="controls">
                <div class="control-group">
                    <label for="progressionTimerInput">Time per progression (s)</label>
                    <input type="number" id="progressionTimerInput" value="30" min="5" max="300">
                </div>
            </div>

            <div class="progression-display">
                <div class="progression-info" id="progressionNumber">PROGRESSION 1 / 10</div>
                <div class="progression-description" id="progressionDescription">Classic "four‑chord" pop progression</div>
                <div class="progression-key" id="progressionKey">KEY: C MAJOR</div>
                
                <div class="progression-sequence" id="progressionSequence">
                    <!-- Chords will be inserted here -->
                </div>

                <div class="timer">
                    <div class="timer-display" id="progressionTimerDisplay">30</div>
                </div>
            </div>

            <div class="progress-tracker" id="progressTracker">
                <!-- Progress dots will be inserted here -->
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progressionProgressBar"></div>
            </div>

            <div class="controls">
                <button id="startProgressionsBtn" class="btn-primary" onclick="startProgressions()">Start</button>
                <button id="pauseProgressionsBtn" class="btn-primary" onclick="pauseProgressions()" style="display: none;">Pause</button>
                <button onclick="resetProgressions()">Reset</button>
                <button onclick="newKey()">New Key</button>
            </div>
        </div>
    </div>

    <script>
        const chords = [
            { name: 'C', type: 'Major' },
            { name: 'D', type: 'Major' },
            { name: 'E', type: 'Major' },
            { name: 'F', type: 'Major' },
            { name: 'G', type: 'Major' },
            { name: 'A', type: 'Major' },
            { name: 'B', type: 'Major' },
            { name: 'C', type: 'Minor' },
            { name: 'D', type: 'Minor' },
            { name: 'E', type: 'Minor' },
            { name: 'F', type: 'Minor' },
            { name: 'G', type: 'Minor' },
            { name: 'A', type: 'Minor' },
            { name: 'B', type: 'Minor' }
        ];

        // Chord progressions in Roman numeral notation
        const progressions = [
            { numerals: ['I', 'V', 'vi', 'IV'], name: 'I – V – vi – IV', keyType: 'Major', description: 'Classic "four‑chord" pop progression' },
            { numerals: ['vi', 'IV', 'I', 'V'], name: 'vi – IV – I – V', keyType: 'Major', description: 'Starts on minor, popular in pop/rock' },
            { numerals: ['I', 'vi', 'IV', 'V'], name: 'I – vi – IV – V', keyType: 'Major', description: 'Another common four‑chord variation' },
            { numerals: ['IV', 'V', 'I', 'vi'], name: 'IV – V – I – vi', keyType: 'Major', description: 'Circular feel, often in pop songs' },
            { numerals: ['I', 'IV', 'V'], name: 'I – IV – V', keyType: 'Major', description: 'Basic three‑chord progression, rock/folk' },
            { numerals: ['ii', 'V', 'I'], name: 'ii – V – I', keyType: 'Major', description: 'Jazz standard progression' },
            { numerals: ['i', 'VII', 'VI', 'V'], name: 'i – VII – VI – V', keyType: 'Minor', description: 'Descending minor progression' },
            { numerals: ['I', 'vi', 'ii', 'V'], name: 'I – vi – ii – V', keyType: 'Major', description: 'Turnaround, jazz/pop standard' },
            { numerals: ['I', 'IV', 'bVII', 'IV'], name: 'I – IV – ♭VII – IV', keyType: 'Major', description: 'Rock/pop flavour using ♭VII' },
            { numerals: ['vi', 'ii', 'V', 'I'], name: 'vi – ii – V – I', keyType: 'Major', description: 'Circle of fifths root motion' }
        ];

        // Major and minor scales
        const majorScale = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const minorScale = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
        const allKeys = [
            { root: 'C', type: 'Major' },
            { root: 'D', type: 'Major' },
            { root: 'E', type: 'Major' },
            { root: 'F', type: 'Major' },
            { root: 'G', type: 'Major' },
            { root: 'A', type: 'Major' },
            { root: 'B', type: 'Major' },
            { root: 'A', type: 'Minor' },
            { root: 'B', type: 'Minor' },
            { root: 'C', type: 'Minor' },
            { root: 'D', type: 'Minor' },
            { root: 'E', type: 'Minor' },
            { root: 'F', type: 'Minor' },
            { root: 'G', type: 'Minor' }
        ];

        // Function to convert Roman numeral to chord in a specific key
        function numeralToChord(numeral, keyRoot, keyType) {
            const scale = keyType === 'Major' ? majorScale : minorScale;
            const rootIndex = scale.indexOf(keyRoot);
            
            // Rotate scale to start from key root
            const rotatedScale = [...scale.slice(rootIndex), ...scale.slice(0, rootIndex)];
            
            // Parse numeral
            let degree = 0;
            let isMinor = false;
            let isFlat = false;
            
            // Check for flat
            if (numeral.startsWith('b')) {
                isFlat = true;
                numeral = numeral.substring(1);
            }
            
            // Check if lowercase (minor)
            if (numeral === numeral.toLowerCase()) {
                isMinor = true;
            }
            
            // Convert to degree
            const numeralMap = { 'i': 0, 'ii': 1, 'iii': 2, 'iv': 3, 'v': 4, 'vi': 5, 'vii': 6 };
            degree = numeralMap[numeral.toLowerCase()];
            
            // Handle flat
            if (isFlat) {
                degree = (degree - 1 + 7) % 7;
            }
            
            const chordRoot = rotatedScale[degree];
            
            // Determine chord quality based on scale degree and numeral
            let chordType;
            if (keyType === 'Major') {
                // Major key: I, IV, V are major; ii, iii, vi are minor; vii° is diminished (treat as minor for simplicity)
                if (numeral.toUpperCase() === 'I' || numeral.toUpperCase() === 'IV' || numeral.toUpperCase() === 'V' || numeral.toUpperCase() === 'VII') {
                    chordType = 'Major';
                } else {
                    chordType = 'Minor';
                }
            } else {
                // Minor key: i, iv are minor; V, VI, VII are major
                if (numeral === numeral.toLowerCase()) {
                    chordType = 'Minor';
                } else {
                    chordType = 'Major';
                }
            }
            
            return { name: chordRoot, type: chordType, numeral: numeral };
        }

        let practiceChords = [...chords];
        let currentIndex = 0;
        let timeRemaining = 30;
        let timerInterval;
        let isRunning = false;
        let isShuffle = false;

        // Chord changes variables
        let changeTimerInterval;
        let changeTimeRemaining = 30;
        let isChangesRunning = false;
        let currentChordPair = [];
        let sessionPairs = [];
        let currentPairIndex = 0;

        // Progressions variables
        let progressionTimerInterval;
        let progressionTimeRemaining = 30;
        let isProgressionsRunning = false;
        let currentKey = null;
        let currentProgressionIndex = 0;
        let currentProgressionChords = [];

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playBeep(frequency = 800) {
            const now = audioContext.currentTime;
            const oscillator = audioContext.createOscillator();
            const gain = audioContext.createGain();

            oscillator.connect(gain);
            gain.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);

            oscillator.start(now);
            oscillator.stop(now + 0.1);
        }

        // Mode switching
        function switchMode(mode) {
            // Stop any running timers
            pausePractice();
            pauseChanges();
            pauseProgressions();

            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.mode-content').forEach(content => content.classList.remove('active'));

            if (mode === 'single') {
                document.querySelectorAll('.mode-btn')[0].classList.add('active');
                document.getElementById('singleMode').classList.add('active');
            } else if (mode === 'changes') {
                document.querySelectorAll('.mode-btn')[1].classList.add('active');
                document.getElementById('changesMode').classList.add('active');
                if (currentChordPair.length === 0) {
                    generateNewPair();
                }
            } else if (mode === 'progressions') {
                document.querySelectorAll('.mode-btn')[2].classList.add('active');
                document.getElementById('progressionsMode').classList.add('active');
                if (!currentKey) {
                    initializeProgressions();
                }
            }
        }

        // Single Chord Mode Functions
        function displayChords() {
            const list = document.getElementById('chordsList');
            list.innerHTML = '';
            practiceChords.forEach((chord, idx) => {
                const tag = document.createElement('div');
                tag.className = 'chord-tag';
                if (idx === currentIndex) tag.classList.add('current');
                tag.textContent = `${chord.name}${chord.type === 'Minor' ? 'm' : ''}`;
                list.appendChild(tag);
            });
        }

        function updateDisplay() {
            const chord = practiceChords[currentIndex];
            document.getElementById('currentChord').textContent = chord.name;
            document.getElementById('chordInfo').textContent = chord.type.toUpperCase();
            document.getElementById('timerDisplay').textContent = Math.ceil(timeRemaining);
            
            const progress = (timeRemaining / parseInt(document.getElementById('timerInput').value)) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            displayChords();
        }

        function nextChord() {
            currentIndex = (currentIndex + 1) % practiceChords.length;
            timeRemaining = parseInt(document.getElementById('timerInput').value);
            updateDisplay();
            document.getElementById('currentChord').classList.add('pulse');
            setTimeout(() => document.getElementById('currentChord').classList.remove('pulse'), 500);
        }

        function startPractice() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            
            timerInterval = setInterval(() => {
                timeRemaining -= 0.1;
                updateDisplay();

                if (timeRemaining <= 0) {
                    playBeep();
                    nextChord();
                }
            }, 100);
        }

        function pausePractice() {
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
        }

        function resetPractice() {
            pausePractice();
            currentIndex = 0;
            timeRemaining = parseInt(document.getElementById('timerInput').value);
            updateDisplay();
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            document.getElementById('shuffleBtn').textContent = `Shuffle: ${isShuffle ? 'ON' : 'OFF'}`;
            document.getElementById('shuffleBtn').classList.toggle('active');
            
            if (isShuffle) {
                practiceChords = [...chords].sort(() => Math.random() - 0.5);
            } else {
                practiceChords = [...chords];
            }
            
            currentIndex = 0;
            timeRemaining = parseInt(document.getElementById('timerInput').value);
            updateDisplay();
        }

        // Chord Changes Mode Functions
        function generateNewPair() {
            const shuffled = [...chords].sort(() => Math.random() - 0.5);
            currentChordPair = [shuffled[0], shuffled[1]];
            updateChangesDisplay();
        }

        function generateSessionPairs() {
            // Generate multiple unique pairs for the session
            sessionPairs = [];
            const usedPairs = new Set();
            
            while (sessionPairs.length < 10) { // Generate 10 pairs for variety
                const shuffled = [...chords].sort(() => Math.random() - 0.5);
                const pairKey = `${shuffled[0].name}${shuffled[0].type}-${shuffled[1].name}${shuffled[1].type}`;
                const reversePairKey = `${shuffled[1].name}${shuffled[1].type}-${shuffled[0].name}${shuffled[0].type}`;
                
                if (!usedPairs.has(pairKey) && !usedPairs.has(reversePairKey)) {
                    sessionPairs.push([shuffled[0], shuffled[1]]);
                    usedPairs.add(pairKey);
                }
            }
            currentPairIndex = 0;
            currentChordPair = sessionPairs[0];
        }

        function nextChordPair() {
            currentPairIndex = (currentPairIndex + 1) % sessionPairs.length;
            currentChordPair = sessionPairs[currentPairIndex];
            changeTimeRemaining = parseInt(document.getElementById('changeTimerInput').value);
            updateChangesDisplay();
            
            // Flash animation for new pair
            document.querySelectorAll('.chord-pair .chord').forEach(el => {
                el.classList.add('pulse');
                setTimeout(() => el.classList.remove('pulse'), 500);
            });
        }

        function updateChangesDisplay() {
            const chord1 = currentChordPair[0];
            const chord2 = currentChordPair[1];
            
            document.querySelector('#chord1 .chord').textContent = chord1.name;
            document.querySelector('#chord1 .type').textContent = chord1.type.toUpperCase();
            document.querySelector('#chord2 .chord').textContent = chord2.name;
            document.querySelector('#chord2 .type').textContent = chord2.type.toUpperCase();
            
            document.getElementById('changeTimerDisplay').textContent = Math.ceil(changeTimeRemaining);
            
            const progress = (changeTimeRemaining / parseInt(document.getElementById('changeTimerInput').value)) * 100;
            document.getElementById('changeProgressBar').style.width = progress + '%';
        }

        function startChanges() {
            if (isChangesRunning) return;
            
            // Generate session pairs if not already done
            if (sessionPairs.length === 0) {
                generateSessionPairs();
            }
            
            isChangesRunning = true;
            document.getElementById('startChangesBtn').style.display = 'none';
            document.getElementById('pauseChangesBtn').style.display = 'inline-block';
            
            changeTimerInterval = setInterval(() => {
                changeTimeRemaining -= 0.1;
                updateChangesDisplay();

                if (changeTimeRemaining <= 0) {
                    playBeep(1000); // Higher pitch beep for time up
                    nextChordPair();
                }
            }, 100);
        }

        function pauseChanges() {
            isChangesRunning = false;
            clearInterval(changeTimerInterval);
            document.getElementById('startChangesBtn').style.display = 'inline-block';
            document.getElementById('pauseChangesBtn').style.display = 'none';
        }

        function resetChanges() {
            pauseChanges();
            changeTimeRemaining = parseInt(document.getElementById('changeTimerInput').value);
            sessionPairs = [];
            generateNewPair();
            updateChangesDisplay();
        }

        // Progressions Mode Functions
        function initializeProgressions() {
            // Pick any random key (major or minor)
            currentKey = allKeys[Math.floor(Math.random() * allKeys.length)];
            currentProgressionIndex = 0;
            generateProgressionChords();
            updateProgressionsDisplay();
            initializeProgressTracker();
        }

        function generateProgressionChords() {
            // Find the next progression that matches the current key type
            let attempts = 0;
            while (attempts < progressions.length) {
                const progression = progressions[currentProgressionIndex];
                
                // Check if this progression matches the current key type
                if (progression.keyType === currentKey.type) {
                    // Good match - generate the chords
                    currentProgressionChords = progression.numerals.map(numeral => 
                        numeralToChord(numeral, currentKey.root, currentKey.type)
                    );
                    return;
                } else {
                    // Skip to next progression
                    currentProgressionIndex = (currentProgressionIndex + 1) % progressions.length;
                    attempts++;
                }
            }
            
            // If we get here, no matching progressions found (shouldn't happen)
            // Just generate with current progression anyway
            const progression = progressions[currentProgressionIndex];
            currentProgressionChords = progression.numerals.map(numeral => 
                numeralToChord(numeral, currentKey.root, currentKey.type)
            );
        }

        function updateProgressionsDisplay() {
            // Get current progression
            const currentProgression = progressions[currentProgressionIndex];
            
            // Update progression number
            document.getElementById('progressionNumber').textContent = 
                `PROGRESSION ${currentProgressionIndex + 1} / ${progressions.length}`;
            
            // Update description
            document.getElementById('progressionDescription').textContent = 
                currentProgression.description;
            
            // Update key
            document.getElementById('progressionKey').textContent = 
                `KEY: ${currentKey.root} ${currentKey.type.toUpperCase()}`;
            
            // Update chord sequence
            const sequenceContainer = document.getElementById('progressionSequence');
            sequenceContainer.innerHTML = '';
            
            currentProgressionChords.forEach((chord, idx) => {
                if (idx > 0) {
                    const arrow = document.createElement('div');
                    arrow.className = 'progression-arrow';
                    arrow.textContent = '→';
                    sequenceContainer.appendChild(arrow);
                }
                
                const chordDiv = document.createElement('div');
                chordDiv.className = 'progression-chord';
                
                const chordName = document.createElement('div');
                chordName.className = 'chord';
                chordName.textContent = `${chord.name}${chord.type === 'Minor' ? 'm' : ''}`;
                
                const numeral = document.createElement('div');
                numeral.className = 'numeral';
                numeral.textContent = chord.numeral;
                
                chordDiv.appendChild(chordName);
                chordDiv.appendChild(numeral);
                sequenceContainer.appendChild(chordDiv);
            });
            
            // Update timer
            document.getElementById('progressionTimerDisplay').textContent = 
                Math.ceil(progressionTimeRemaining);
            
            const progress = (progressionTimeRemaining / parseInt(document.getElementById('progressionTimerInput').value)) * 100;
            document.getElementById('progressionProgressBar').style.width = progress + '%';
            
            // Update progress tracker
            updateProgressTracker();
        }

        function initializeProgressTracker() {
            const tracker = document.getElementById('progressTracker');
            tracker.innerHTML = '';
            
            for (let i = 0; i < progressions.length; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (i === 0) dot.classList.add('current');
                tracker.appendChild(dot);
            }
        }

        function updateProgressTracker() {
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, idx) => {
                dot.classList.remove('current', 'completed');
                if (idx < currentProgressionIndex) {
                    dot.classList.add('completed');
                } else if (idx === currentProgressionIndex) {
                    dot.classList.add('current');
                }
            });
        }

        function nextProgression() {
            currentProgressionIndex++;
            
            // Check if we've completed all progressions
            if (currentProgressionIndex >= progressions.length) {
                // Move to any new random key (major or minor)
                const oldKey = currentKey;
                
                do {
                    currentKey = allKeys[Math.floor(Math.random() * allKeys.length)];
                } while (allKeys.length > 1 && currentKey.root === oldKey.root && currentKey.type === oldKey.type);
                
                currentProgressionIndex = 0;
            }
            
            progressionTimeRemaining = parseInt(document.getElementById('progressionTimerInput').value);
            generateProgressionChords(); // This will auto-skip to matching progression
            updateProgressionsDisplay();
            
            // Pulse animation
            document.querySelectorAll('.progression-chord .chord').forEach(el => {
                el.classList.add('pulse');
                setTimeout(() => el.classList.remove('pulse'), 500);
            });
        }

        function startProgressions() {
            if (isProgressionsRunning) return;
            
            isProgressionsRunning = true;
            document.getElementById('startProgressionsBtn').style.display = 'none';
            document.getElementById('pauseProgressionsBtn').style.display = 'inline-block';
            
            progressionTimerInterval = setInterval(() => {
                progressionTimeRemaining -= 0.1;
                updateProgressionsDisplay();

                if (progressionTimeRemaining <= 0) {
                    playBeep(1200); // Even higher pitch for progression change
                    nextProgression();
                }
            }, 100);
        }

        function pauseProgressions() {
            isProgressionsRunning = false;
            clearInterval(progressionTimerInterval);
            document.getElementById('startProgressionsBtn').style.display = 'inline-block';
            document.getElementById('pauseProgressionsBtn').style.display = 'none';
        }

        function resetProgressions() {
            pauseProgressions();
            progressionTimeRemaining = parseInt(document.getElementById('progressionTimerInput').value);
            initializeProgressions();
        }

        function newKey() {
            pauseProgressions();
            
            // Pick any random key (major or minor), avoiding the current one
            const oldKey = currentKey;
            do {
                currentKey = allKeys[Math.floor(Math.random() * allKeys.length)];
            } while (allKeys.length > 1 && currentKey.root === oldKey.root && currentKey.type === oldKey.type);
            
            // Regenerate chords for current progression in the new key
            // This will auto-skip to a matching progression if needed
            progressionTimeRemaining = parseInt(document.getElementById('progressionTimerInput').value);
            generateProgressionChords();
            updateProgressionsDisplay();
            
            // Pulse animation
            document.querySelectorAll('.progression-chord .chord').forEach(el => {
                el.classList.add('pulse');
                setTimeout(() => el.classList.remove('pulse'), 500);
            });
        }

        // Event listeners
        document.getElementById('timerInput').addEventListener('change', () => {
            if (!isRunning) {
                timeRemaining = parseInt(document.getElementById('timerInput').value);
                updateDisplay();
            }
        });

        document.getElementById('changeTimerInput').addEventListener('change', () => {
            if (!isChangesRunning) {
                changeTimeRemaining = parseInt(document.getElementById('changeTimerInput').value);
                updateChangesDisplay();
            }
        });

        document.getElementById('progressionTimerInput').addEventListener('change', () => {
            if (!isProgressionsRunning) {
                progressionTimeRemaining = parseInt(document.getElementById('progressionTimerInput').value);
                updateProgressionsDisplay();
            }
        });

        // Initialize
        updateDisplay();
        generateNewPair();
        initializeProgressions();
    </script>

    <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js");
  }
    </script>
</body>
</html>
